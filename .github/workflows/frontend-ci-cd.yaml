name: Frontend CI/CD

on:
  push:
    branches:
      - main
      - dev
      - dev2

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  K8S_NAMESPACE: ${{ secrets.K8S_NAMESPACE }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
      tag: ${{ steps.set-image.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-image
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          BRANCH=$(echo "${GITHUB_REF#refs/heads/}" | tr '/' '-')
          TAG="${BRANCH}-${SHORT_SHA}"
          IMAGE="${{ env.ACR_LOGIN_SERVER }}/frontend:${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          tags: ${{ steps.set-image.outputs.image }}

      - name: Trivy scan image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.set-image.outputs.image }}
          format: 'table'
          scan-type: 'image'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS credentials
        uses: azure/aks-set-context@v2
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

      - name: Apply namespace & service
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/frontend-svc.yaml

      - name: Deploy updated image
        run: |
          IMAGE="${{ needs.build-and-push.outputs.image }}"
          echo "Deploying image: $IMAGE"
          # create tmp manifest with image substituted
          sed "s|REPLACE_WITH_IMAGE|$IMAGE|g" k8s/frontend-deploy.yaml > k8s/frontend-deploy.tmp.yaml
          kubectl apply -f k8s/frontend-deploy.tmp.yaml

      - name: Trigger rolling update and wait (automated rollback on failure)
        run: |
          kubectl -n ${{ secrets.K8S_NAMESPACE }} set image deployment/frontend frontend=${{ needs.build-and-push.outputs.image }}
          if ! kubectl -n ${{ secrets.K8S_NAMESPACE }} rollout status deployment/frontend --timeout=180s; then
            echo "Rollout failed; rolling back"
            kubectl -n ${{ secrets.K8S_NAMESPACE }} rollout undo deployment/frontend
            exit 1
          fi
