name: Backend Blue-Green Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
env:
  REGISTRY: ujjwal8087.azurecr.io
  IMAGE_NAME: backend
  NAMESPACE: capstone-project

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure Container Registry
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
    - name: ACR Login
      run: az acr login --name ujjwal8087    


        

    - name: Build & Push Docker Image
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        IMAGE="ujjwal8087.azurecr.io/backend:main-$IMAGE_TAG"

        docker build -f ./backend/Dockerfile -t $IMAGE backend
        docker push $IMAGE

        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

    # ğŸš€ Deploy GREEN (inject image)
    - name: Deploy GREEN backend
      run: |
        kubectl -n $NAMESPACE set image deployment/backend-green \
          backend=$IMAGE

    # â³ Wait until GREEN is healthy
    - name: Wait for GREEN readiness
      run: |
        kubectl -n $NAMESPACE rollout status deployment/backend-green \
          --timeout=120s

    # ğŸ”€ Switch traffic BLUE â†’ GREEN
    - name: Switch traffic to GREEN
      run: |
        kubectl -n $NAMESPACE patch svc backend \
          -p '{"spec":{"selector":{"app":"backend","version":"green"}}}'

    # ğŸ§¯ Rollback automatically if something fails
    - name: Rollback on failure
      if: failure()
      run: |
        echo "Rolling back traffic to BLUE"
        kubectl -n $NAMESPACE patch svc backend \
          -p '{"spec":{"selector":{"app":"backend","version":"blue"}}}'
